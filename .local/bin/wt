#!/bin/zsh

# Git Worktree Switcher for tmux

# First argument is the target pane ID (passed from tmux). If not provided, fall back to the
# current pane when invoked from inside tmux.
TARGET_PANE="${1:-$TMUX_PANE}"

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not in a git repository"
    sleep 1
    exit 1
fi

# Get all worktrees with branch names
worktrees=$(git worktree list --porcelain | awk '
    /^worktree /{wt=$2; branch=""; next}
    /^branch /{branch=$2; sub("refs/heads/","",branch); next}
    /^detached/{branch="(detached)"; next}
    /^bare/{branch="(bare)"; next}
    /^$/{
        if (wt!=""){
            b=(branch=="" ? "(no-branch)" : branch);
            print wt "\t" b;
            wt=""; branch=""
        }
        next
    }
    END{
        if (wt!=""){
            b=(branch=="" ? "(no-branch)" : branch);
            print wt "\t" b;
        }
    }
')

if [[ -z "$worktrees" ]]; then
    echo "No worktrees found"
    sleep 1
    exit 1
fi

# Use plain fzf (we're already in a popup)
selected=$(echo "$worktrees" |
    fzf --reverse \
        --prompt="Worktree > " \
        --header="Select worktree" \
        --delimiter="\t" \
        --with-nth=1,2 \
        --preview="cd {1} 2>/dev/null && git branch --show-current && echo && git log --oneline -5" \
        --preview-window=right:50%)
fzf_status=$?

# Exit quietly if picker was cancelled
if [[ $fzf_status -ne 0 || -z "$selected" ]]; then
    exit 0
fi

selected_path=$(echo "$selected" | cut -f1)

if [[ -n "$TARGET_PANE" ]]; then
    tmux send-keys -t "$TARGET_PANE" "cd '$selected_path'" C-m
else
    echo "No target pane available to cd into the selected worktree"
    sleep 1
fi
