#!/bin/zsh

export FZF_DEFAULT_OPTS="--color=bg+:#363a4f,bg:#24273a,spinner:#f4dbd6,hl:#ed8796 --color=fg:#cad3f5,header:#ed8796,info:#c6a0f6,pointer:#f4dbd6 --color=marker:#f4dbd6,fg+:#cad3f5,prompt:#c6a0f6,hl+:#ed8796"

CONFIG_FILE="$HOME/.local/bin/tnav_dirs.yaml"

DIRS=()
while IFS= read -r line; do
	DIRS+=("$HOME/$line")
done < <(yq e '.directories[]' $CONFIG_FILE)

fzf_tmux_call() {
  fd . "$@" |
    awk -v home=$HOME '{gsub(home, "~"); print}' |
    fzf-tmux -p 40%,50% --reverse --expect "alt-enter,enter,ctrl-t,ctrl-o"| 
    xargs echo
}

fzf_call() {
  fd . "$@" |
    awk -v home=$HOME '{gsub(home, "~"); print}' |
    fzf --reverse --expect "alt-enter,enter,ctrl-t,ctrl-o"| 
    xargs echo
}

# Check last argument value.
LAST_ARG="${@:$#}"
RUN_TMUX=false
if [[ $LAST_ARG = "--tmux" ]]; then
	RUN_TMUX=true
fi

if [[ -z $1 ]]; then
	OUTPUT=$(fzf_tmux_call "${DIRS[@]}" | sd '~' $HOME)
elif [[ $LAST_ARG =~ ^(--tmux)$ ]]; then
	OUTPUT=$(fzf_call "${DIRS[@]}" | sd '~' $HOME)
elif [[ $LAST_ARG =~ ^(--relative|-r)$ ]]; then
  cd "$(fd -t d | fzf-tmux -p 40%,50% --reverse --height=40% --layout=reverse)"
else
	echo "Invalid argument passed"
fi

read -r KEYPRESS BASE_PATH <<<"${OUTPUT}"

if [ -z $BASE_PATH ]; then
	return
fi

BASE_NAME=$(basename $BASE_PATH)
PARENT_PATH=$(dirname $BASE_PATH)
PARENT_NAME=$(basename $PARENT_PATH | tr -d '.')
PATH_IS_DIR=false
PATH_IS_FILE=false
PATH_IS_CONFIG=false
SESSION_IS_RUNNING=false
START_TMUX=false


start_new_session() {
	if [[ "$START_TMUX" = true ]]; then
		tmux start-server
	fi

	if [[ "$PATH_IS_DIR" = true ]]; then
    zoxide add $BASE_PATH
		tmux new-session -ds $BASE_NAME -c $BASE_PATH
	elif [[ "$PATH_IS_FILE" = true ]]; then
    zoxide add $PARENT_PATH
		tmux new-session -ds $PARENT_NAME -c $PARENT_PATH
	fi
	SESSION_IS_RUNNING=true
}

jump_to_open_session() {
	if [[ -z "$TMUX" ]]; then
		tmux attach
	else
		if [[ "$PATH_IS_DIR" = true ]]; then
      tmux switch-client -t $BASE_NAME
		elif [[ "$PATH_IS_FILE" = true ]]; then
			tmux switch-client -t $PARENT_NAME
		fi
	fi

}

open_directory() {
	if [ "$KEYPRESS" = "enter" ]; then
		if [[ "$RUN_TMUX" = true ]]; then
			start_new_session
			if [[ "$PATH_IS_CONFIG" = true ]]; then
				tmux send-keys -t config.0 "$EDITOR" ENTER
			else
				tmux send-keys -t $BASE_NAME.0 "$EDITOR" ENTER
			fi
			jump_to_open_session
		else
      zoxide add $BASE_PATH
			cd $BASE_PATH
			$EDITOR
		fi
	elif [[ "$KEYPRESS" = "alt-enter" ]]; then
		if [[ "$RUN_TMUX" = true ]]; then
			start_new_session
			jump_to_open_session
		else
      zoxide add $BASE_PATH
			cd $BASE_PATH
		fi
	else
		return
	fi
}

open_file() {
	if [ "$KEYPRESS" = "enter" ]; then
		if [[ "$RUN_TMUX" = true ]]; then
			start_new_session
      tmux send-keys -t $PARENT_NAME.0 "$EDITOR $BASE_NAME" ENTER
			jump_to_open_session
		else
      cd $PARENT_PATH
      $EDITOR $BASE_NAME
		fi
	elif [[ "$KEYPRESS" = "alt-enter" ]]; then
		if [[ "$RUN_TMUX" = true ]]; then
			start_new_session
			jump_to_open_session
		else
			cd $PARENT_PATH
		fi
	else
		return
	fi
}

if [ -d $BASE_PATH ]; then
	BASE_PATH=${BASE_PATH%?} # Only needed if using fd command
	PATH_IS_DIR=true
	open_directory
else
	PATH_IS_FILE=true
	open_file
fi
